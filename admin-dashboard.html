<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sozo Skills</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left h1 { font-size: 2em; margin-bottom: 5px; }
        .header-left p { opacity: 0.9; }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-info {
            text-align: right;
        }
        .user-info .username {
            font-weight: 600;
            font-size: 1.1em;
        }
        .user-info .login-time {
            font-size: 0.85em;
            opacity: 0.8;
        }
        .logout-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .logout-btn:hover {
            background: white;
            color: #667eea;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
        }
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters select, .filters input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        .filters button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
        }
        .filters button:hover {
            background: #5568d3;
        }
        .applications-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .section-header {
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-header h2 {
            color: #667eea;
            font-size: 1.5em;
        }
        .export-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .export-btn:hover {
            background: #229954;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: #f8f9fa;
        }
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        .status-approved {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 0 3px;
            font-weight: 600;
        }
        .btn-view {
            background: #667eea;
            color: white;
        }
        .btn-view:hover {
            background: #5568d3;
        }
        .btn-approve {
            background: #27ae60;
            color: white;
        }
        .btn-approve:hover {
            background: #229954;
        }
        .btn-reject {
            background: #e74c3c;
            color: white;
        }
        .btn-reject:hover {
            background: #c0392b;
        }
        .btn-delete {
            background: #e67e22;
            color: white;
        }
        .btn-delete:hover {
            background: #d35400;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 0;
            width: 90%;
            max-width: 900px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
        }
        .close {
            font-size: 2em;
            cursor: pointer;
            color: white;
        }
        .close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .detail-section {
            margin-bottom: 30px;
        }
        .detail-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        .detail-label {
            font-weight: 600;
            color: #555;
        }
        .detail-value {
            color: #333;
        }
        .score-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        .score-display .score {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
        }
        .score-display .label {
            color: #666;
            margin-top: 10px;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .container { padding: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .detail-grid { grid-template-columns: 1fr; gap: 5px; }
            .action-btn { display: block; margin: 5px 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üéì Sozo Skills Admin Dashboard</h1>
            <p>Manage Applications & Monitor Progress</p>
        </div>
        <div class="header-right">
            <div class="user-info">
                <div class="username" id="displayUsername">Admin</div>
                <div class="login-time" id="loginTime"></div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Applications</h3>
                <div class="number" id="totalApps">0</div>
            </div>
            <div class="stat-card">
                <h3>Assessments Completed</h3>
                <div class="number" id="completedAssessments">0</div>
            </div>
            <div class="stat-card">
                <h3>Pending Review</h3>
                <div class="number" id="pendingReview">0</div>
            </div>
            <div class="stat-card">
                <h3>Average Baseline Score</h3>
                <div class="number" id="avgScore">0</div>
            </div>
        </div>

        <div class="filters">
            <select id="programFilter">
                <option value="">All Programs</option>
                <option value="Artisan Baking">Artisan Baking</option>
                <option value="Barista">Barista</option>
                <option value="Hair">Hair</option>
                <option value="Beauty">Beauty</option>
            </select>

            <select id="statusFilter">
                <option value="">All Statuses</option>
                <option value="Pending Assessment">Pending Assessment</option>
                <option value="Assessment Completed - Pending Review">Assessment Completed</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
            </select>

            <select id="areaFilter">
                <option value="">All Areas</option>
                <option value="Vrygrond">Vrygrond</option>
                <option value="Muizenberg">Muizenberg</option>
                <option value="Lakeside">Lakeside</option>
                <option value="Ocean View">Ocean View</option>
                <option value="Fish Hoek">Fish Hoek</option>
            </select>

            <input type="text" id="searchInput" placeholder="Search by name or ID...">

            <button onclick="applyFilters()">Apply Filters</button>
            <button onclick="resetFilters()">Reset</button>
        </div>

        <div class="applications-section">
            <div class="section-header">
                <h2>Applications</h2>
                <button class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>App ID</th>
                            <th>Name</th>
                            <th>Program</th>
                            <th>Age</th>
                            <th>Area</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Baseline Score</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody">
                        <tr>
                            <td colspan="9" class="no-data">No applications found</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Application Details</h2>
                <span class="close" onclick="closeModal()">√ó</span>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        if (sessionStorage.getItem('sozoAdminLoggedIn') !== 'true') {
            window.location.href = 'admin-login.html';
        }

        // Display user info
        const username = sessionStorage.getItem('sozoAdminUser');
        const loginTime = sessionStorage.getItem('sozoLoginTime');
        document.getElementById('displayUsername').textContent = username;
        document.getElementById('loginTime').textContent = 'Logged in: ' + new Date(parseInt(loginTime)).toLocaleTimeString();

        // Auto logout after 2 hours of inactivity
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                alert('Session expired due to inactivity');
                logout();
            }, 2 * 60 * 60 * 1000); // 2 hours
        }
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        resetInactivityTimer();

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('sozoAdminLoggedIn');
                sessionStorage.removeItem('sozoAdminUser');
                sessionStorage.removeItem('sozoLoginTime');
                window.location.href = 'admin-login.html';
            }
        }

        let allApplications = [];
        let filteredApplications = [];

        window.addEventListener('DOMContentLoaded', function() {
            loadApplications();
        });

        function loadApplications() {
            allApplications = JSON.parse(localStorage.getItem('sozoApplications')) || [];
            filteredApplications = [...allApplications];
            updateStatistics();
            renderTable();
        }

        function updateStatistics() {
            const total = allApplications.length;
            const completed = allApplications.filter(app => app.assessmentCompleted).length;
            const pending = allApplications.filter(app => app.applicationStatus && app.applicationStatus.includes('Pending')).length;
            
            const scoresArray = allApplications
                .filter(app => app.baselineScore)
                .map(app => parseFloat(app.baselineScore));
            const avgScore = scoresArray.length > 0 
                ? (scoresArray.reduce((a, b) => a + b, 0) / scoresArray.length).toFixed(2)
                : 0;

            document.getElementById('totalApps').textContent = total;
            document.getElementById('completedAssessments').textContent = completed;
            document.getElementById('pendingReview').textContent = pending;
            document.getElementById('avgScore').textContent = avgScore;
        }

        function renderTable() {
            const tbody = document.getElementById('applicationsTableBody');
            
            if (filteredApplications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">No applications found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredApplications.map(app => `
                <tr>
                    <td>${app.id}</td>
                    <td>${app.firstName} ${app.lastName}</td>
                    <td>${app.program}</td>
                    <td>${app.age}</td>
                    <td>${app.area}</td>
                    <td>${new Date(app.submissionDate).toLocaleDateString()}</td>
                    <td><span class="status-badge ${getStatusClass(app.applicationStatus)}">${app.applicationStatus}</span></td>
                    <td>${app.baselineScore || 'N/A'}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewApplication('${app.id}')">View</button>
                        ${!app.applicationStatus.includes('Approved') && !app.applicationStatus.includes('Rejected') ? `
                            <button class="action-btn btn-approve" onclick="updateStatus('${app.id}', 'Approved')">Approve</button>
                            <button class="action-btn btn-reject" onclick="updateStatus('${app.id}', 'Rejected')">Reject</button>
                        ` : ''}
                        <button class="action-btn btn-delete" onclick="deleteApplication('${app.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            if (!status) return 'status-pending';
            if (status.includes('Pending')) return 'status-pending';
            if (status.includes('Approved')) return 'status-approved';
            if (status.includes('Rejected')) return 'status-rejected';
            if (status.includes('Completed')) return 'status-completed';
            return 'status-pending';
        }

        function viewApplication(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;

            let html = `
                <div class="detail-section">
                    <h3>üìã Personal Information</h3>
                    <div class="detail-grid">
                        <div class="detail-label">Application ID:</div>
                        <div class="detail-value"><strong>${app.id}</strong></div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Full Name:</div>
                        <div class="detail-value">${app.firstName} ${app.lastName}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">ID Number:</div>
                        <div class="detail-value">${app.idNumber}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Date of Birth:</div>
                        <div class="detail-value">${app.dateOfBirth} (Age: ${app.age})</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Gender:</div>
                        <div class="detail-value">${app.gender}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Race:</div>
                        <div class="detail-value">${app.race}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Disability:</div>
                        <div class="detail-value">${app.disability}${app.disabilityType ? ' - ' + app.disabilityType : ''}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üìû Contact Information</h3>
                    <div class="detail-grid">
                        <div class="detail-label">Mobile:</div>
                        <div class="detail-value">${app.mobile}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Alt. Mobile:</div>
                        <div class="detail-value">${app.altMobile || 'N/A'}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Email:</div>
                        <div class="detail-value">${app.email || 'N/A'}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Area:</div>
                        <div class="detail-value">${app.area}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Address:</div>
                        <div class="detail-value">${app.address}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üéì Educational & Employment</h3>
                    <div class="detail-grid">
                        <div class="detail-label">Education Level:</div>
                        <div class="detail-value">${app.education}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Employment Status:</div>
                        <div class="detail-value">${app.employmentStatus}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Household Income:</div>
                        <div class="detail-value">${app.income}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Dependents:</div>
                        <div class="detail-value">${app.dependents}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>üéØ Program Information</h3>
                    <div class="detail-grid">
                        <div class="detail-label">Selected Program:</div>
                        <div class="detail-value"><strong>${app.program}</strong></div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Motivation:</div>
                        <div class="detail-value">${app.motivation}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Previous Experience:</div>
                        <div class="detail-value">${app.experience}${app.experienceDetails ? ' - ' + app.experienceDetails : ''}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Referral Source:</div>
                        <div class="detail-value">${app.referralSource}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Transportation:</div>
                        <div class="detail-value">${app.transport}</div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Special Requirements:</div>
                        <div class="detail-value">${app.specialRequirements || 'None'}</div>
                    </div>
                </div>
            `;

            if (app.assessment) {
                const assessment = app.assessment;
                html += `
                    <div class="detail-section">
                        <h3>üìù Pre-Training Assessment Results</h3>
                        
                        <div class="score-display">
                            <div class="score">${app.baselineScore}/5.0</div>
                            <div class="label">Baseline Score</div>
                        </div>

                        <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Technical Knowledge</h4>
                        <div class="detail-grid">
                            <div class="detail-label">Technical Knowledge:</div>
                            <div class="detail-value">${assessment.technicalKnowledge}/5</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Tools Experience:</div>
                            <div class="detail-value">${assessment.toolsExperience}</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Existing Skills:</div>
                            <div class="detail-value">${assessment.existingSkills}</div>
                        </div>

                        <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Practical Skills</h4>
                        <div class="detail-grid">
                            <div class="detail-label">Follow Instructions:</div>
                            <div class="detail-value">${assessment.followInstructions}/5</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Time Management:</div>
                            <div class="detail-value">${assessment.timeManagement}/5</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Teamwork:</div>
                            <div class="detail-value">${assessment.teamwork}/5</div>
                        </div>

                        <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Communication</h4>
                        <div class="detail-grid">
                            <div class="detail-label">Customer Communication:</div>
                            <div class="detail-value">${assessment.customerCommunication}/5</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Languages:</div>
                            <div class="detail-value">${assessment.languages}</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Asking for Help:</div>
                            <div class="detail-value">${assessment.askingHelp}/5</div>
                        </div>

                        <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Digital Literacy</h4>
                        <div class="detail-grid">
                            <div class="detail-label">Smartphone:</div>
                            <div class="detail-value">${assessment.smartphone}</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Social Media:</div>
                            <div class="detail-value">${assessment.socialMedia}/5</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Computer Use:</div>
                            <div class="detail-value">${assessment.computerUse}</div>
                        </div>

                        <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Work Readiness</h4>
                        <div class="detail-grid">
                            <div class="detail-label">Employment Importance:</div>
                            <div class="detail-value">${assessment.employmentImportance}/5</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Business Interest:</div>
                            <div class="detail-value">${assessment.businessInterest}</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Commitment:</div>
                            <div class="detail-value">${assessment.commitment}/5</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Goals:</div>
                            <div class="detail-value">${assessment.goals}</div>
                        </div>

                        <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Support Needs</h4>
                        <div class="detail-grid">
                            <div class="detail-label">Challenges:</div>
                            <div class="detail-value">${assessment.challenges}</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Support Needs:</div>
                            <div class="detail-value">${assessment.supportNeeds || 'None specified'}</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Family Support:</div>
                            <div class="detail-value">${assessment.familySupport}</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-label">Assessment Date:</div>
                            <div class="detail-value">${new Date(assessment.assessmentDate).toLocaleString()}</div>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="detail-section">
                        <h3>üìù Assessment Status</h3>
                        <p style="color: #e74c3c; text-align: center; padding: 20px;">Assessment not yet completed</p>
                    </div>
                `;
            }

            html += `
                <div class="detail-section">
                    <h3>üìä Application Status</h3>
                    <div class="detail-grid">
                        <div class="detail-label">Current Status:</div>
                        <div class="detail-value"><span class="status-badge ${getStatusClass(app.applicationStatus)}">${app.applicationStatus}</span></div>
                    </div>
                    <div class="detail-grid">
                        <div class="detail-label">Submission Date:</div>
                        <div class="detail-value">${new Date(app.submissionDate).toLocaleString()}</div>
                    </div>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function updateStatus(appId, newStatus) {
            const message = newStatus === 'Approved' 
                ? 'Are you sure you want to approve this application?' 
                : 'Are you sure you want to reject this application?';
            
            if (!confirm(message)) {
                return;
            }

            const appIndex = allApplications.findIndex(app => app.id === appId);
            if (appIndex !== -1) {
                allApplications[appIndex].applicationStatus = newStatus;
                allApplications[appIndex].statusUpdatedBy = username;
                allApplications[appIndex].statusUpdatedDate = new Date().toISOString();
                localStorage.setItem('sozoApplications', JSON.stringify(allApplications));
                loadApplications();
                alert(`Application ${newStatus.toLowerCase()} successfully!`);
            }
        }

        function deleteApplication(appId) {
            const app = allApplications.find(a => a.id === appId);
            if (!app) return;

            const confirmMessage = `‚ö†Ô∏è WARNING: You are about to permanently delete this application:\n\nID: ${app.id}\nName: ${app.firstName} ${app.lastName}\nProgram: ${app.program}\n\nThis action CANNOT be undone!\n\nType "DELETE" in the next prompt to confirm.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            const verification = prompt('Type DELETE to confirm deletion:');
            if (verification !== 'DELETE') {
                alert('Deletion cancelled. Verification text did not match.');
                return;
            }

            // Remove from array
            allApplications = allApplications.filter(a => a.id !== appId);
            localStorage.setItem('sozoApplications', JSON.stringify(allApplications));
            
            // Close modal if open
            closeModal();
            
            // Reload data
            loadApplications();
            
            alert(`Application ${app.id} has been permanently deleted.`);
        }

        function applyFilters() {
            const programFilter = document.getElementById('programFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredApplications = allApplications.filter(app => {
                const matchesProgram = !programFilter || app.program === programFilter;
                const matchesStatus = !statusFilter || app.applicationStatus === statusFilter;
                const matchesArea = !areaFilter || app.area === areaFilter;
                const matchesSearch = !searchTerm || 
                    app.firstName.toLowerCase().includes(searchTerm) ||
                    app.lastName.toLowerCase().includes(searchTerm) ||
                    app.id.toLowerCase().includes(searchTerm);

                return matchesProgram && matchesStatus && matchesArea && matchesSearch;
            });

            renderTable();
        }

        function resetFilters() {
            document.getElementById('programFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('areaFilter').value = '';
            document.getElementById('searchInput').value = '';
            filteredApplications = [...allApplications];
            renderTable();
        }

        function exportToCSV() {
            if (filteredApplications.length === 0) {
                alert('No data to export');
                return;
            }

            // Enhanced CSV header with all important fields
            let csv = 'Application ID,Submission Date,Status,First Name,Last Name,ID Number,Date of Birth,Age,Gender,Race,Disability,Disability Type,Mobile Number,Alternative Mobile,Email,Area,Address,Education Level,Employment Status,Household Income,Number of Dependents,Program Selected,Motivation,Previous Experience,Experience Details,Referral Source,Transportation,Special Requirements,Assessment Completed,Baseline Score,Technical Knowledge,Follow Instructions,Time Management,Teamwork,Customer Communication,Languages,Asking for Help,Smartphone Ownership,Social Media Proficiency,Computer Use,Employment Importance,Business Interest,Commitment Level,Goals,Challenges,Support Needs,Family Support\n';

            filteredApplications.forEach(app => {
                // Personal Information
                const appId = app.id || '';
                const submissionDate = new Date(app.submissionDate).toLocaleString();
                const status = app.applicationStatus || '';
                const firstName = app.firstName || '';
                const lastName = app.lastName || '';
                const idNumber = app.idNumber || '';
                const dob = app.dateOfBirth || '';
                const age = app.age || '';
                const gender = app.gender || '';
                const race = app.race || '';
                const disability = app.disability || '';
                const disabilityType = app.disabilityType || '';
                
                // Contact Information
                const mobile = app.mobile || '';
                const altMobile = app.altMobile || '';
                const email = app.email || '';
                const area = app.area || '';
                const address = (app.address || '').replace(/"/g, '""');
                
                // Educational & Employment
                const education = app.education || '';
                const employmentStatus = app.employmentStatus || '';
                const income = app.income || '';
                const dependents = app.dependents || '';
                
                // Program Information
                const program = app.program || '';
                const motivation = (app.motivation || '').replace(/"/g, '""');
                const experience = app.experience || '';
                const experienceDetails = (app.experienceDetails || '').replace(/"/g, '""');
                const referralSource = app.referralSource || '';
                const transport = app.transport || '';
                const specialRequirements = (app.specialRequirements || '').replace(/"/g, '""');
                
                // Assessment Information
                const assessmentCompleted = app.assessmentCompleted ? 'Yes' : 'No';
                const baselineScore = app.baselineScore || '';
                
                // Assessment Details (if completed)
                let technicalKnowledge = '';
                let followInstructions = '';
                let timeManagement = '';
                let teamwork = '';
                let customerCommunication = '';
                let languages = '';
                let askingHelp = '';
                let smartphone = '';
                let socialMedia = '';
                let computerUse = '';
                let employmentImportance = '';
                let businessInterest = '';
                let commitment = '';
                let goals = '';
                let challenges = '';
                let supportNeeds = '';
                let familySupport = '';
                
                if (app.assessment) {
                    technicalKnowledge = app.assessment.technicalKnowledge || '';
                    followInstructions = app.assessment.followInstructions || '';
                    timeManagement = app.assessment.timeManagement || '';
                    teamwork = app.assessment.teamwork || '';
                    customerCommunication = app.assessment.customerCommunication || '';
                    languages = (app.assessment.languages || '').replace(/"/g, '""');
                    askingHelp = app.assessment.askingHelp || '';
                    smartphone = app.assessment.smartphone || '';
                    socialMedia = app.assessment.socialMedia || '';
                    computerUse = app.assessment.computerUse || '';
                    employmentImportance = app.assessment.employmentImportance || '';
                    businessInterest = app.assessment.businessInterest || '';
                    commitment = app.assessment.commitment || '';
                    goals = (app.assessment.goals || '').replace(/"/g, '""');
                    challenges = (app.assessment.challenges || '').replace(/"/g, '""');
                    supportNeeds = (app.assessment.supportNeeds || '').replace(/"/g, '""');
                    familySupport = app.assessment.familySupport || '';
                }
                
                // Build CSV row
                csv += `"${appId}","${submissionDate}","${status}","${firstName}","${lastName}","${idNumber}","${dob}","${age}","${gender}","${race}","${disability}","${disabilityType}","${mobile}","${altMobile}","${email}","${area}","${address}","${education}","${employmentStatus}","${income}","${dependents}","${program}","${motivation}","${experience}","${experienceDetails}","${referralSource}","${transport}","${specialRequirements}","${assessmentCompleted}","${baselineScore}","${technicalKnowledge}","${followInstructions}","${timeManagement}","${teamwork}","${customerCommunication}","${languages}","${askingHelp}","${smartphone}","${socialMedia}","${computerUse}","${employmentImportance}","${businessInterest}","${commitment}","${goals}","${challenges}","${supportNeeds}","${familySupport}"\n`;
            });

            // Create and download the file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `Sozo_Skills_Applications_Export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert(`Successfully exported ${filteredApplications.length} application(s) to CSV!`);
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
